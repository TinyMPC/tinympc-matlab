% Test code generation for quadrotor

clear; clc;
addpath(fullfile(fileparts(mfilename('fullpath')), '..', 'src', 'matlab_wrapper'));

Adyn = [...
    1.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0245250, 0.0000000, 0.0500000, 0.0000000, 0.0000000, 0.0000000, 0.0002044, 0.0000000;
    0.0000000, 1.0000000, 0.0000000, -0.0245250, 0.0000000, 0.0000000, 0.0000000, 0.0500000, 0.0000000, -0.0002044, 0.0000000, 0.0000000;
    0.0000000, 0.0000000, 1.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0500000, 0.0000000, 0.0000000, 0.0000000;
    0.0000000, 0.0000000, 0.0000000, 1.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0250000, 0.0000000, 0.0000000;
    0.0000000, 0.0000000, 0.0000000, 0.0000000, 1.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0250000, 0.0000000;
    0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 1.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0250000;
    0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.9810000, 0.0000000, 1.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0122625, 0.0000000;
    0.0000000, 0.0000000, 0.0000000, -0.9810000, 0.0000000, 0.0000000, 0.0000000, 1.0000000, 0.0000000, -0.0122625, 0.0000000, 0.0000000;
    0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 1.0000000, 0.0000000, 0.0000000, 0.0000000;
    0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 1.0000000, 0.0000000, 0.0000000;
    0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 1.0000000, 0.0000000;
    0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 1.0000000];
Bdyn = [...
    -0.0007069, 0.0007773, 0.0007091, -0.0007795;
    0.0007034, 0.0007747, -0.0007042, -0.0007739;
    0.0052554, 0.0052554, 0.0052554, 0.0052554;
    -0.1720966, -0.1895213, 0.1722891, 0.1893288;
    -0.1729419, 0.1901740, 0.1734809, -0.1907131;
    0.0123423, -0.0045148, -0.0174024, 0.0095748;
    -0.0565520, 0.0621869, 0.0567283, -0.0623632;
    0.0562756, 0.0619735, -0.0563386, -0.0619105;
    0.2102143, 0.2102143, 0.2102143, 0.2102143;
    -13.7677303, -15.1617018, 13.7831318, 15.1463003;
    -13.8353509, 15.2139209, 13.8784751, -15.2570451;
    0.9873856, -0.3611820, -1.3921880, 0.7659845];
Q_diag = [100.0000000, 100.0000000, 100.0000000, 4.0000000, 4.0000000, 400.0000000, ...
          4.0000000, 4.0000000, 4.0000000, 2.0408163, 2.0408163, 4.0000000];
R_diag = [4.0000000, 4.0000000, 4.0000000, 4.0000000];
Q = diag(Q_diag);
R = diag(R_diag);
N = 20;
u_min = -0.5;
u_max = 0.5;
rho_value = 5.0;

try
    prob = TinyMPC();
    prob.setup(Adyn, Bdyn, Q, R, N, 'u_min', u_min, 'u_max', u_max, 'rho', rho_value);
    outdir = 'out';
    if ~exist(outdir, 'dir'), mkdir(outdir); end
    prob.codegen(outdir);
    assert(exist(fullfile(outdir, 'CMakeLists.txt'), 'file') == 2, 'Codegen failed: CMakeLists.txt missing');
    fprintf('test_quadrotor_codegen.m: PASSED\n');
catch ME
    if contains(ME.message, 'tinympc_matlab')
        fprintf('test_quadrotor_codegen.m: SKIPPED (MEX file not compiled)\n');
    else
        fprintf('test_quadrotor_codegen.m: ERROR - %s\n', ME.message);
        rethrow(ME);
    end
end

function list_files_recursive(dir_path, prefix)
    items = dir(dir_path);
    for i = 1:length(items)
        if ~strcmp(items(i).name, '.') && ~strcmp(items(i).name, '..')
            full_path = fullfile(dir_path, items(i).name);
            if items(i).isdir
                fprintf('%s%s/\n', prefix, items(i).name);
                list_files_recursive(full_path, [prefix, '  ']);
            else
                fprintf('%s%s\n', prefix, items(i).name);
            end
        end
    end
end
